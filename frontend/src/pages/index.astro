---
import '../styles/theme.css';
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skynet Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="matrix-bg text-green-400 min-h-screen flex font-mono overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-black border-r border-green-900 flex flex-col z-40 hidden md:flex">
        <div class="p-4 border-b border-green-900">
            <button id="new-chat-btn" class="w-full py-2 px-4 border border-green-500 rounded hover:bg-green-900 transition-colors flex items-center justify-center gap-2 text-sm">
                <span>+</span> New Chat
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="conversations-list">
            <!-- Conversations will be loaded here -->
        </div>
        <div class="p-4 border-t border-green-900 text-xs text-green-700">
            <div>MODEL: <span id="model-info">...</span></div>
            <div>HOST: <span id="host-info">...</span></div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col relative h-screen">
        <!-- Header (Mobile only mostly, or simple status) -->
        <div class="absolute top-0 left-0 right-0 p-4 z-30 pointer-events-none flex justify-between md:justify-end">
            <button id="mobile-menu-btn" class="md:hidden pointer-events-auto text-green-500 border border-green-500 px-2 rounded">â˜°</button>
            <div class="text-xs font-bold glow opacity-50">SKYNET TERMINAL</div>
        </div>

        <!-- Chat Area -->
        <main class="flex-1 overflow-hidden flex flex-col relative">
            <div id="messages-panel" class="flex-1 overflow-y-auto p-4 pb-32 scroll-smooth">
                <div id="chat-box" class="flex flex-col pb-4 max-w-3xl mx-auto w-full">
                    <!-- Messages -->
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <div class="w-full bg-gradient-to-t from-black via-black to-transparent p-4 pb-6 z-50">
            <div class="max-w-3xl mx-auto relative">
                <form id="chat-form" class="relative">
                    <input type="text" id="prompt-input" 
                        placeholder="Send a command..." 
                        class="w-full p-4 pr-12 rounded-lg bg-black border border-green-800 text-green-400 placeholder-green-900 focus:outline-none focus:border-green-500 shadow-[0_0_15px_rgba(0,255,0,0.1)] transition-all"
                        autocomplete="off"
                    >
                    <button type="submit" id="send-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-green-600 hover:text-green-400 transition-colors">
                        â–¶
                    </button>
                    <button type="button" id="stop-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-red-600 hover:text-red-400 transition-colors hidden">
                        â– 
                    </button>
                </form>
                <div class="text-center text-[10px] text-green-900 mt-2 uppercase tracking-widest">
                    Authorized Personnel Only
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentConversationId: number | null = null;
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        let isThinking = false;

        // DOM Elements
        const chatBox = document.getElementById('chat-box');
        const messagesPanel = document.getElementById('messages-panel');
        const conversationsList = document.getElementById('conversations-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const modelInfoEl = document.getElementById('model-info');
        const hostInfoEl = document.getElementById('host-info');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');

        // System Info
        fetch('/api/info')
            .then(res => res.json())
            .then(data => {
                if (modelInfoEl) modelInfoEl.textContent = data.model;
                if (hostInfoEl) hostInfoEl.textContent = data.hostname;
            })
            .catch(err => console.error('Failed to fetch system info:', err));

        // Load Conversations
        async function loadConversations() {
            try {
                const res = await fetch('/api/conversations');
                const conversations = await res.json();
                if (conversationsList) {
                    conversationsList.innerHTML = conversations.map((c: any) => `
                        <button onclick="switchConversation(${c.id})" class="w-full text-left px-3 py-2 rounded hover:bg-green-900/30 text-xs truncate transition-colors ${c.id === currentConversationId ? 'bg-green-900/50 text-green-300' : 'text-green-600'}">
                            ${c.title}
                        </button>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load conversations:', err);
            }
        }

        // Switch Conversation
        // @ts-ignore
        window.switchConversation = async (id) => {
            currentConversationId = id;
            if (chatBox) chatBox.innerHTML = ''; // Clear current messages
            
            // Load messages
            try {
                const res = await fetch(`/api/conversations/${id}`);
                const messages = await res.json();
                messages.forEach((msg: any) => appendMessage(msg.role, msg.content));
                loadConversations(); // Refresh list to update active state
            } catch (err) {
                console.error('Failed to load messages:', err);
            }
        };

        // New Chat
        newChatBtn?.addEventListener('click', () => {
            currentConversationId = null;
            if (chatBox) chatBox.innerHTML = '';
            loadConversations();
        });

        // Initial Load
        loadConversations();

        // WebSocket Logic
        function scrollMessages() {
            if (messagesPanel) {
                messagesPanel.scrollTop = messagesPanel.scrollHeight;
            }
        }
        
        function setThinking(thinking: boolean) {
            isThinking = thinking;
            if (thinking) {
                sendBtn?.classList.add('hidden');
                stopBtn?.classList.remove('hidden');
                
                if (chatBox && !document.getElementById('thinking-loader')) {
                    const loaderDiv = document.createElement('div');
                    loaderDiv.id = 'thinking-loader';
                    loaderDiv.className = 'message-container agent';
                    loaderDiv.innerHTML = `
                        <div class="avatar agent">ðŸ¤–</div>
                        <div class="message-content">
                            <div class="flex items-center gap-2 text-green-500">
                                <span class="loader"></span>
                                <span class="loader" style="animation-delay: 0.2s;"></span>
                                <span class="loader" style="animation-delay: 0.4s;"></span>
                                <span class="text-sm">Processing...</span>
                            </div>
                        </div>
                    `;
                    chatBox.appendChild(loaderDiv);
                    requestAnimationFrame(scrollMessages);
                }
            } else {
                sendBtn?.classList.remove('hidden');
                stopBtn?.classList.add('hidden');
                const loader = document.getElementById('thinking-loader');
                if (loader) loader.remove();
            }
        }
        
        /**
         * @param {string} role
         * @param {string} content
         */
        function appendMessage(role: string, content: string) {
            if (!chatBox) return;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message-container ${role === 'user' ? 'user' : 'agent'}`;
            
            let avatarHtml = role === 'user' ? '<div class="avatar user">ðŸ‘¤</div>' : '<div class="avatar agent">ðŸ¤–</div>';
            let contentHtml = '';

            // Parse Markdown
            // @ts-ignore
            const parsedContent = marked.parse(content);

            if (role === 'user') {
                contentHtml = `<div class="markdown-content text-green-100">${parsedContent}</div>`;
            } else if (role === 'agent-thought') {
                contentHtml = `
                    <div class="thought-block">
                        <div class="text-xs text-yellow-500 mb-1">THOUGHT PROCESS</div>
                        <div class="markdown-content text-sm">${parsedContent}</div>
                    </div>`;
            } else if (role === 'agent-action') {
                const isError = content.includes('Error') || content.includes('Exception');
                const borderColor = isError ? 'border-red-500' : 'border-blue-500';
                const titleColor = isError ? 'text-red-400' : 'text-blue-400';
                const title = isError ? 'SYSTEM ERROR' : 'SYSTEM ACTION';
                
                contentHtml = `
                    <div class="action-block ${borderColor}">
                        <details open>
                            <summary class="text-xs ${titleColor} mb-1 cursor-pointer hover:text-white select-none flex items-center gap-2">
                                <span>${title}</span>
                                <span class="text-[10px] opacity-50">(Click to toggle)</span>
                            </summary>
                            <div class="console-output mt-2 pl-2 border-l border-green-900/50">${content}</div>
                        </details>
                    </div>`;
            } else {
                contentHtml = `<div class="markdown-content">${parsedContent}</div>`;
            }

            msgDiv.innerHTML = `
                ${avatarHtml}
                <div class="message-content">
                    ${contentHtml}
                </div>
            `;
            
            chatBox.appendChild(msgDiv);
            requestAnimationFrame(scrollMessages);
        }

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'conversation_created') {
                currentConversationId = data.id;
                loadConversations();
                return;
            }

            // If we receive a message, we might still be thinking if it's a thought/action
            // But if it's a final answer or we are done, we stop thinking.
            // Actually, the backend sends messages as they come.
            // We only hide loader if we are sure we are done? 
            // No, the loader is a placeholder for "waiting for next message".
            // So we remove it, append message, and if it's an intermediate step, show it again.
            
            const loader = document.getElementById('thinking-loader');
            if (loader) loader.remove();
            
            appendMessage(data.role, data.content);
            
            if (data.role === 'agent-thought' || data.role === 'agent-action') {
                setThinking(true);
            } else if (data.role === 'assistant' || data.role === 'system') {
                // Usually final message or system info
                setThinking(false);
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            setThinking(false);
        };

        const chatForm = document.getElementById('chat-form');
        const promptInput = document.getElementById('prompt-input');
        
        if (chatForm && promptInput instanceof HTMLInputElement) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const goal = promptInput.value;
                if (goal) {
                    appendMessage('user', goal);
                    ws.send(JSON.stringify({
                        goal: goal,
                        conversation_id: currentConversationId
                    }));
                    promptInput.value = '';
                    setThinking(true);
                }
            });
            
            stopBtn?.addEventListener('click', function() {
                ws.send(JSON.stringify({ action: "stop" }));
                setThinking(false);
            });
        }
    </script>
</body>
</html>