---
import '../styles/theme.css';
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skynet Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="matrix-bg text-green-400 min-h-screen flex flex-col font-mono">
    <!-- Header / Status Bar -->
    <div class="fixed top-0 left-0 right-0 bg-black bg-opacity-90 border-b border-green-900 p-2 z-50 flex justify-between items-center px-4">
        <div class="text-lg font-bold glow">SKYNET v2.0</div>
        <div class="flex gap-4 text-xs">
            <div>MODEL: <span id="model-info" class="text-green-200">...</span></div>
            <div>HOST: <span id="host-info" class="text-blue-300">...</span></div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <main class="flex-1 pt-12 pb-32 flex flex-col">
        <div id="messages-panel" class="flex-1 overflow-y-auto">
            <div id="chat-box" class="flex flex-col pb-4">
                <!-- Messages will be appended here -->
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <div class="fixed bottom-0 left-0 right-0 input-area p-4 z-50">
        <div class="max-w-3xl mx-auto">
            <form id="chat-form" class="relative">
                <input type="text" id="prompt-input" 
                    placeholder="Send a command to Skynet..." 
                    class="w-full p-4 pr-12 rounded-lg chat-input bg-black text-green-400 placeholder-green-800 focus:outline-none"
                    autocomplete="off"
                >
                <button type="submit" class="absolute right-2 top-2 bottom-2 px-4 text-green-500 hover:text-green-300 transition-colors">
                    â–¶
                </button>
            </form>
            <div class="text-center text-xs text-green-800 mt-2">
                Skynet may produce inaccurate information about people, places, or facts.
            </div>
        </div>
    </div>

    <script>
        // System Info
        const modelInfoEl = document.getElementById('model-info');
        const hostInfoEl = document.getElementById('host-info');

        fetch('/api/info')
            .then(res => res.json())
            .then(data => {
                if (modelInfoEl) modelInfoEl.textContent = data.model;
                if (hostInfoEl) hostInfoEl.textContent = data.hostname;
            })
            .catch(err => console.error('Failed to fetch system info:', err));

        // WebSocket
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        let isThinking = false;

        function scrollMessages() {
            const panel = document.getElementById('messages-panel');
            if (panel) {
                panel.scrollTop = panel.scrollHeight;
            }
        }
        
        function showLoader() {
            if (isThinking) return;
            isThinking = true;
            const chatBox = document.getElementById('chat-box');
            if (!chatBox) return;
            
            const loaderDiv = document.createElement('div');
            loaderDiv.id = 'thinking-loader';
            loaderDiv.className = 'message-container agent';
            loaderDiv.innerHTML = `
                <div class="avatar agent">ðŸ¤–</div>
                <div class="message-content">
                    <div class="flex items-center gap-2 text-green-500">
                        <span class="loader"></span>
                        <span class="loader" style="animation-delay: 0.2s;"></span>
                        <span class="loader" style="animation-delay: 0.4s;"></span>
                        <span class="text-sm">Processing...</span>
                    </div>
                </div>
            `;
            chatBox.appendChild(loaderDiv);
            requestAnimationFrame(scrollMessages);
        }
        
        function hideLoader() {
            isThinking = false;
            const loader = document.getElementById('thinking-loader');
            if (loader) loader.remove();
        }
        
        /**
         * @param {string} role
         * @param {string} content
         */
        function appendMessage(role: string, content: string) {
            const chatBox = document.getElementById('chat-box');
            if (!chatBox) return;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message-container ${role === 'user' ? 'user' : 'agent'}`;
            
            let avatarHtml = role === 'user' ? '<div class="avatar user">ðŸ‘¤</div>' : '<div class="avatar agent">ðŸ¤–</div>';
            let contentHtml = '';

            // Parse Markdown
            // @ts-ignore
            const parsedContent = marked.parse(content);

            if (role === 'user') {
                contentHtml = `<div class="markdown-content text-green-100">${parsedContent}</div>`;
            } else if (role === 'agent-thought') {
                contentHtml = `
                    <div class="thought-block">
                        <div class="text-xs text-yellow-500 mb-1">THOUGHT PROCESS</div>
                        <div class="markdown-content text-sm">${parsedContent}</div>
                    </div>`;
            } else if (role === 'agent-action') {
                const isError = content.includes('Error') || content.includes('Exception');
                const borderColor = isError ? 'border-red-500' : 'border-blue-500';
                const titleColor = isError ? 'text-red-400' : 'text-blue-400';
                const title = isError ? 'SYSTEM ERROR' : 'SYSTEM ACTION';
                
                contentHtml = `
                    <div class="action-block ${borderColor}">
                        <div class="text-xs ${titleColor} mb-1">${title}</div>
                        <div class="console-output">${content}</div>
                    </div>`;
            } else {
                // Standard agent message
                contentHtml = `<div class="markdown-content">${parsedContent}</div>`;
            }

            msgDiv.innerHTML = `
                ${avatarHtml}
                <div class="message-content">
                    ${contentHtml}
                </div>
            `;
            
            chatBox.appendChild(msgDiv);
            requestAnimationFrame(scrollMessages);
        }

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            hideLoader();
            appendMessage(data.role, data.content);
            if (data.role === 'agent-thought' || data.role === 'agent-action') {
                showLoader();
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        const chatForm = document.getElementById('chat-form');
        const promptInput = document.getElementById('prompt-input');
        
        if (chatForm && promptInput instanceof HTMLInputElement) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const goal = promptInput.value;
                if (goal) {
                    appendMessage('user', goal);
                    ws.send(JSON.stringify({goal: goal}));
                    promptInput.value = '';
                    showLoader();
                }
            });
        }
    </script>
</body>
</html>